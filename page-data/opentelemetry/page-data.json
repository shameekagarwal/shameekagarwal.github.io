{"componentChunkName":"component---src-templates-blog-js","path":"/opentelemetry/","result":{"data":{"markdownRemark":{"fields":{"slug":"/opentelemetry/"},"id":"a30e3675-92ac-5c9c-9fa4-e0693aa2559a","html":"<h1 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h1>\n<ul>\n<li>observability - how well the internal state of a system can be inferred from its external outputs</li>\n<li>incident response timeline - mttd (mean time to detect), mttk (mean time to know), mttf (mean time to fix), mttv (mean time to verify), mttrec (mean time to recover), mttres (mean time to resolution)\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; margin: 5px 0 5px 0 !important;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0d3bae5c5d4500808adb8c25290aae86/8fdfc/incident-response.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.177215189873415%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAC4jAAAuIwF4pT92AAABMElEQVQY0y1QTUvEMBDtv/e/uOBZRATBw+JJUHYFpdsu3W6zTdJMkqZNMulIWt9lPt+8mSmmaRrH0VqrtRZCMMb6vhcrlFIAoFYMwwAAQggppdYaEYmoCCHM8+y9DyEopbquu16vW7iVEBFTSohuHBljl8sFAFJaMlmPrud8kPLGRRYCkFICAOd809l0lTZsMNlq7ayOwWcydi16nwd5tcSJiKSUP8dvIlqWpWmayTkiSnDDz5c454bjWX1VQ8JYiId7VVfaOdd+WH4KMZ3K8u3p2XvvnNvv9+e6cjGZ8tPs7jRniOHxvd69/lqtiqqut8NgENYAETnnuBAppRhj27Z93xMRaH08HKZpJqKmacqyzGtba40x6yelsXZcEUKgFTHGZcm/SYje+38/IWLO/wGVaYtGvqBoXwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"incident response\"\n        title=\"incident response\"\n        src=\"/static/0d3bae5c5d4500808adb8c25290aae86/f058b/incident-response.png\"\n        srcset=\"/static/0d3bae5c5d4500808adb8c25290aae86/c26ae/incident-response.png 158w,\n/static/0d3bae5c5d4500808adb8c25290aae86/6bdcf/incident-response.png 315w,\n/static/0d3bae5c5d4500808adb8c25290aae86/f058b/incident-response.png 630w,\n/static/0d3bae5c5d4500808adb8c25290aae86/40601/incident-response.png 945w,\n/static/0d3bae5c5d4500808adb8c25290aae86/78612/incident-response.png 1260w,\n/static/0d3bae5c5d4500808adb8c25290aae86/8fdfc/incident-response.png 1725w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nnote that observability helps with mttd, mttk, mttv</li>\n<li>regression - a feature that worked before and has now stopped working</li>\n<li>for effectiveness, we need to discard telemetry data that is of no use and causes noise</li>\n<li>there are a lot of different observability backends like statsd, prometheus, etc. application owners will either have to rely on the same observability backends as the library developers, or library developers have to support a myriad of different observability backends</li>\n<li>opentelemetry (cncf) is a result of merging of opentracing (cncf) and opencensus (google)</li>\n</ul>\n<h1 id=\"specification\" style=\"position:relative;\"><a href=\"#specification\" aria-label=\"specification permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Specification</h1>\n<ul>\n<li>a living document that has requirements which any component like api, sdk, protocol, semantic conventions, etc. need to implement to consider their implementation compliant</li>\n<li>this helps ensure uniformity across telemetry backends and languages and frameworks</li>\n<li>while we can raise issues and mrs for minor improvements to the specification, for major improvements, we need to go through a formal process called otep (opentelemetry enhancement protocol). after an otep is approved, relevant issues are created in the different components of opentelemetry</li>\n</ul>\n<h1 id=\"signals-and-components\" style=\"position:relative;\"><a href=\"#signals-and-components\" aria-label=\"signals and components permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Signals and Components</h1>\n<ul>\n<li>opentelemetry has four types of signals - traces, metrics, logs and baggage</li>\n<li>context is shared across all signals which helps correlate signals across different services</li>\n<li>each signal has four components -\n<ul>\n<li>api - public interfaces with minimum implementation. this is what application / library developers should usually interact with for implementing their cross-cutting concerns</li>\n<li>semantic conventions - standardize telemetry data across languages and observability backends</li>\n<li>sdk - implementation of api. with opentelemetry, library developers and application developers only interact with the opentelemetry api to instrument their code, and the choices around observability backends are made by configuring the opentelemetry sdk</li>\n<li>contrib packages - instrumentation libraries, plugins for different observability backends, etc</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"instrumentation-libraries\" style=\"position:relative;\"><a href=\"#instrumentation-libraries\" aria-label=\"instrumentation libraries permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instrumentation Libraries</h1>\n<ul>\n<li>the “instrumentation library” instruments the “instrumented library”. if the library itself interacts with opentelemetry (which is what should move towards), these two become the same</li>\n<li>different methods can be used, e.g. bytecode injection in java, monkey patching in python, etc</li>\n<li>auto instrumentation - uses a java agent, and should be preferred over manually configuring it using the opentelemetry sdk. however, using the opentelemetry sdk is unavoidable sometimes</li>\n<li>todo - spi (service provider interface), extensions</li>\n</ul>\n<h1 id=\"semantic-conventions\" style=\"position:relative;\"><a href=\"#semantic-conventions\" aria-label=\"semantic conventions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Semantic Conventions</h1>\n<ul>\n<li>labelling telemetry data across languages and services in a standard way to help in correlation</li>\n<li>resource conventions - semantic conventions for resources. e.g. service group - <code class=\"language-text\">service.name</code> (name of the service) <code class=\"language-text\">service.namespace</code> (business area e.g. team name), <code class=\"language-text\">service.instance.id</code> (helps identify the exact replica in the horizontally scaled service) and <code class=\"language-text\">service.version</code>. similarly, we have other groups like <code class=\"language-text\">k8s.*</code>, <code class=\"language-text\">cloud.*</code>, <code class=\"language-text\">host.*</code>, <code class=\"language-text\">container.*</code> and so on</li>\n<li>tracing conventions - tracing conventions also have logical groupings to add attributes to spans in a standard way, e.g. <code class=\"language-text\">exception.*</code>, <code class=\"language-text\">thread.*</code> and so on. apart from this, tracing convention includes concepts naming spans /api/customers/{customer_id} and not for instance /api/customers/45, since it makes the cardinality high and statistical aggregations later difficult</li>\n<li>metric conventions - similar to span attributes, we have groups like <code class=\"language-text\">http.*</code> to help ensure standards</li>\n<li>similarly, logs have conventions as well (for both events and log records)</li>\n<li>telemetry schemas - semantic versions can change over time. this can break our observability solution, e.g. alerting around specific attributes. idea is we send a schema url along with the telemetry data. this contains the transformations necessary to convert telemetry data between versions. this can be used by for e.g. observability backends. opentelemetry collectors can use this to convert to a specific target version</li>\n</ul>\n<h1 id=\"resource\" style=\"position:relative;\"><a href=\"#resource\" aria-label=\"resource permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resource</h1>\n<ul>\n<li>immutable set of attributes associated with telemetry data to find the entity producing it</li>\n<li>e.g. container id, hostname, process, etc</li>\n<li>resource detectors - automatically do this for us</li>\n<li>e.g. of configuring resources -\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">Resource</span> resource <span class=\"token operator\">=</span> <span class=\"token class-name\">Resource</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// telemetry.*, e.g. telemetry.sdk.version, etc</span>\n<span class=\"token comment\">// makes service.name as unknown_service:java which is overwritten in the next line</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">Resource</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>\n      <span class=\"token class-name\">Attributes</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n        <span class=\"token class-name\">ResourceAttributes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SERVICE_NAME</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"deal-service\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">ResourceAttributes</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SERVICE_NAMESPACE</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"equity\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OsResource</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HostResource</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProcessResource</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\nnote - resource instances are immutable, so we need to merge them to obtain new resource instances</li>\n<li>when using java instrumentation agent, we use methods like environment variables / system properties, e.g. <code class=\"language-text\">OTEL_SERVICE_NAME</code>, etc. we might want to configure resources using examples below because having too many redundant resources can add overhead for transportation, latency, storage, etc\n<ul>\n<li>enable some of them - <code class=\"language-text\">otel.java.enabled.resource-providers</code>. by default, all of them are enabled</li>\n<li>disable some of them - <code class=\"language-text\">otel.java.disabled.resource-providers</code></li>\n<li>key value pairs in w3c baggage format for custom resource attributes - <code class=\"language-text\">otel.resource.attributes</code></li>\n<li>disable only selective keys - <code class=\"language-text\">otel.experimental.resource.disabled-keys</code></li>\n</ul>\n</li>\n</ul>\n<h1 id=\"context\" style=\"position:relative;\"><a href=\"#context\" aria-label=\"context permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context</h1>\n<ul>\n<li>helps propagate information about the current execution across threads and even services</li>\n<li>in java for e.g. ThreadLocal is used to maintain context, and this way, we do not have to pass the context ourselves across different function calls that our code makes</li>\n<li>we can attach, detach or obtain the context for the current execution</li>\n<li><u>we should not have to deal with the context api ourselves generally</u>, and ideally we only have to interact with signals which internally interact with the context api</li>\n<li>context is immutable (just like resources?), so a modification returns a new context object</li>\n<li>so, we need to attach this context to the current execution explicitly and then close the scope at the end\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ContextKey</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token constant\">MY_KEY</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">ContextKey</span><span class=\"token punctuation\">.</span><span class=\"token function\">named</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"someKey\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Context</span> myContext <span class=\"token operator\">=</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MY_KEY</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"someValue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Scope</span> myScope <span class=\"token operator\">=</span> myContext<span class=\"token punctuation\">.</span><span class=\"token function\">makeCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmyScope<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\nanother method could use <code class=\"language-text\">String myValue = Context.current().get(MY_KEY);</code> while the scope was open</li>\n<li>the scope implements the <code class=\"language-text\">AutoCloseable</code> interface, so we can use it as follows -\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Scope</span> ignored <span class=\"token operator\">=</span> myContext<span class=\"token punctuation\">.</span><span class=\"token function\">makeCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n</li>\n<li>to ensure that the context is inherited in asynchronous code like by <code class=\"language-text\">Runnable</code>, we can use <code class=\"language-text\">wrap</code>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>for executor services in java, we can use <code class=\"language-text\">taskWrapping</code>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">ExecutorService</span> myExecutor <span class=\"token operator\">=</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token function\">taskWrapping</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\nthis way, the current context is automatically propagated when we make calls like <code class=\"language-text\">myExecutor.execute</code> etc</li>\n<li>when using the java agent, classes like come common executors like <code class=\"language-text\">ForkJoinPool</code> are automatically instrumented (understand that automatic instrumentation over here means that context is propagated to the tasks automatically). sometimes, we might not want this automatic instrumentation (discussed later in tracing) so configure the application accordingly</li>\n</ul>\n<h1 id=\"context-propagation\" style=\"position:relative;\"><a href=\"#context-propagation\" aria-label=\"context propagation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context Propagation</h1>\n<ul>\n<li>opentelemtery uses propagators api to extract context from incoming / inject context into outgoing requests. this helps standardize context propagation across signals (again this is related to how we interact with signals and not context directly?)</li>\n<li>unlike opentracing, opentelemetry decouples context from tracing context</li>\n<li>so, context propagation via propagators api can be used independently by any signal like baggage or trace</li>\n<li><code class=\"language-text\">TextMapPropagator</code> is used by the baggage api. <code class=\"language-text\">TextMapPropagator</code> helps inject context into / extract context from a carrier using string key value pairs</li>\n<li>for context propagation of baggage, for e.g. in http headers, lightstep use <code class=\"language-text\">ot-baggage-{key}: {value}</code>, jaeger use <code class=\"language-text\">uberctx-{key}: {value}</code>, zipkin clients use <code class=\"language-text\">baggage-{key}: {value}</code></li>\n<li>opentelemetry worked with w3c to propose a standard, where one header is used. different baggage items are separated via commas, and metadata is appended using semicolons. e.g. <code class=\"language-text\">baggage: key1=value1;property1;property2, key2 = value2, key3=value3; propertyKey=propertyValue</code></li>\n<li>so, there are different propagators for b3, jaeger, lightstep and the now preferred way we are moving towards, w3c <code class=\"language-text\">Baggage</code> and w3c <code class=\"language-text\">TraceContext</code></li>\n<li>opentelemetry includes the concept of composite propagators, which means we can provide a list of context propagators, so the resultant (context / carrier) is a merge of all of them, and the propagators later in the list overwrites the ones before it</li>\n<li>so, when using the javagaent, use <code class=\"language-text\">otel.propagators</code> to specify a comma separated list of propagators like <code class=\"language-text\">xray</code>, <code class=\"language-text\">tracecontext</code>, <code class=\"language-text\">baggage</code> and so on</li>\n<li>if not using auto instrumentation, we use as follows -\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">OpenTelemetrySdk</span> openTelemetry <span class=\"token operator\">=</span> <span class=\"token class-name\">OpenTelemetrySdk</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setTracerProvider</span><span class=\"token punctuation\">(</span>tracerProvider<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setMeterProvider</span><span class=\"token punctuation\">(</span>meterProvider<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setPropagators</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">ContextPropagators</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>\n      <span class=\"token class-name\">TextMapPropagator</span><span class=\"token punctuation\">.</span><span class=\"token function\">composite</span><span class=\"token punctuation\">(</span>\n        <span class=\"token class-name\">JaegerPropagator</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">W3CTraceContextPropagator</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">W3CBaggagePropagator</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">buildAndRegisterGlobal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h1 id=\"baggage\" style=\"position:relative;\"><a href=\"#baggage\" aria-label=\"baggage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Baggage</h1>\n<ul>\n<li>tracing helps us correlate signals which is a part of a transaction using trace / span ids</li>\n<li>with baggage, we can correlate signals on custom properties</li>\n<li>services can get / set these properties, and we can have them propagated across services automatically</li>\n<li>like described earlier, we should ideally not have to deal with context api ourselves. so, we use tracing api, which internally uses context api for storing trace information for the current context. similarly, we use baggage api for user defined properties, which internally uses the context api for this</li>\n<li>use case - pass browser session id to downstream services which otherwise would not have access to it</li>\n<li>note - since baggage is independent of other telemetry signals, it is not added to attributes of spans and metrics automatically. they need to be added explicitly</li>\n<li>baggage follows the same immutability as resources, context, etc. when we call makeCurrent on it, it mutates the current context as well. we can then clear the baggage from the context as well\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">Baggage</span> myBaggage <span class=\"token operator\">=</span> <span class=\"token class-name\">Baggage</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">toBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"session.id\"</span><span class=\"token punctuation\">,</span> webSessionId<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"myKey\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"myValue\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">BaggageEntryMetadata</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some metadata\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Scope</span> ignored <span class=\"token operator\">=</span> myBaggage<span class=\"token punctuation\">.</span><span class=\"token function\">makeCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">String</span> mySessionId <span class=\"token operator\">=</span> <span class=\"token class-name\">Baggage</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getEntryValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"session.id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">BaggageEntry</span> myValueEntry <span class=\"token operator\">=</span> <span class=\"token class-name\">Baggage</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">asMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"myKey\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">String</span> myValue <span class=\"token operator\">=</span> myValueEntry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">String</span> myMetadata <span class=\"token operator\">=</span> myValueEntry<span class=\"token punctuation\">.</span><span class=\"token function\">getMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Scope</span> ignored <span class=\"token operator\">=</span> <span class=\"token class-name\">Baggage</span><span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">makeCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h1 id=\"tracing\" style=\"position:relative;\"><a href=\"#tracing\" aria-label=\"tracing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tracing</h1>\n<ul>\n<li>spans represent single operations in a transaction</li>\n<li>a transaction here refers to multiple operations running across multiple services</li>\n<li>spans have a start and an end timestamp</li>\n<li>spans are linked to each other to form a trace</li>\n<li>tracing data can be huge in volume, so we have sampling algorithms which can filter out traces that are not relevant for debugging purposes</li>\n<li>we can have metrics on top of spans, but it might not be advisable, since it might not be as effective as metrics by themselves, e.g. sampling skews the distribution towards the worst case scenarios like errors and slow response times, so it might not be a true representation of the actual state of system</li>\n<li>when configuring the opentelemetry sdk, we provide it with a <code class=\"language-text\">TracerProvider</code>. we usually have one <code class=\"language-text\">TracerProvider</code> per application</li>\n<li>we obtain instances of a <code class=\"language-text\">Tracer</code> from a <code class=\"language-text\">TracerProvider</code> which can be used to create spans</li>\n<li>to obtain a <code class=\"language-text\">Tracer</code>, we have to provide the <u>name</u>, <u>version</u>, <u>schema url</u> and <u>attributes</u></li>\n<li>the name, version and schema url uniquely identify a tracer, so when we use the same parameters twice in our codebase, we obtain the same tracer</li>\n<li>we can use either <code class=\"language-text\">TracerProvider</code> or <code class=\"language-text\">OpenTelemetry</code> instance to obtain a tracer\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">Tracer</span> tracer <span class=\"token operator\">=</span> openTelemetry\n  <span class=\"token punctuation\">.</span><span class=\"token function\">tracerBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"my-library\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setInstrumentationVersion</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0.1.0\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setSchemaUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://example.com\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>note - we can obtain <code class=\"language-text\">OpenTelemetry</code> using <code class=\"language-text\">GlobalOpenTelemetry.get()</code>, but using that is not recommended, since it can happen that the global opentelemetry instance was initialized after we already start using it. so, we should use mechanisms like dependency injection for obtaining the <code class=\"language-text\">OpenTelemetry</code> instance</li>\n<li>a span in a trace can have multiple sub spans (parent and child spans)</li>\n<li>a trace starts with a root span</li>\n<li>properties of a span -\n<ul>\n<li>name - should have low cardinality so not include tracing convention</li>\n<li>span context - stored in the context, contains information about the active span in the current execution context like trace id, span id, flags, etc.</li>\n<li>parent span</li>\n<li>span kind -\n<ul>\n<li>client - synchronous call instrumented on the caller side, e.g. http requests. it is not considered finished until a response is received. it is usually the parent of the server span</li>\n<li>server</li>\n<li>producer - asynchronous message, the span finishes before the child span can start processing. it is usually the parent of a span of type consumer</li>\n<li>consumer</li>\n<li>internal - the default. represents an internal operation</li>\n</ul>\n</li>\n<li>start and end timestamp</li>\n<li>attributes - should follow semantic convention where possible</li>\n<li>links - a collection of <code class=\"language-text\">Link</code> instances, where each link is a reference to a span. this span can be present in either the same or a different trace</li>\n<li>events - collection of <code class=\"language-text\">Event</code> instances</li>\n<li>status - describes the outcome of the span. it contains a status code (unset i.e. the default, ok and error) and optionally a description in case of errors</li>\n</ul>\n</li>\n<li>for effectiveness, we need to consider granularity of span. just relying on auto instrumentation can be too generic, and using spans for a method that encompasses 1% of the total operation can add noise</li>\n<li>since context is handled implicitly, when we create a span, it automatically becomes a child of the span which is active in the current execution context\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token keyword\">void</span> <span class=\"token function\">myMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Span</span> parentSpan <span class=\"token operator\">=</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">spanBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main operation\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Scope</span> ignored <span class=\"token operator\">=</span> parentSpan<span class=\"token punctuation\">.</span><span class=\"token function\">makeCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">innerMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    parentSpan<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">innerMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Span</span> childSpan <span class=\"token operator\">=</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">spanBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"inner operation\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Scope</span> ignored <span class=\"token operator\">=</span> childSpan<span class=\"token punctuation\">.</span><span class=\"token function\">makeCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    span<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\nunderstand how the <code class=\"language-text\">parentSpan</code> is automatically made the parent of the <code class=\"language-text\">childSpan</code> bts for us</li>\n<li>we can use links between spans when they are somehow related but do not have a causal relationship. we can also add attributes to links to describe this relationship\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">Span</span> span <span class=\"token operator\">=</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">spanBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"linkedSpan\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setNoParent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">addLink</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">Span</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSpanContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">Attributes</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"submitter\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"mainMethod\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">startSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\nnote the use of <code class=\"language-text\">setNoParent</code> so that the active span is not used as the parent</li>\n<li>we can use <code class=\"language-text\">@WithSpan</code> annotation on methods to make our job easier</li>\n<li>we can also add attributes to spans -\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">Span</span> span <span class=\"token operator\">=</span> <span class=\"token class-name\">Span</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nspan<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"job.title\"</span><span class=\"token punctuation\">,</span> person<span class=\"token punctuation\">.</span><span class=\"token function\">getJobTitle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n</li>\n<li>when we do not have the need for full-fledged spans, we can record some events as a part of spans. these events can also optionally have some attributes associated with it -\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\">span<span class=\"token punctuation\">.</span><span class=\"token function\">addEvent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"something happened\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Attributes</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eventKey\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n</li>\n<li>we can change the status code of a span to error explicitly</li>\n<li>we can also use the <code class=\"language-text\">recordException</code> method, which adds an event with name <code class=\"language-text\">exception</code> and adds attributes like <code class=\"language-text\">exception.type</code>, <code class=\"language-text\">exception.message</code> and <code class=\"language-text\">exception.stacktrace</code>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@WithSpan</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">myMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Span</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StatusCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ERROR</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"an error occurred\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Span</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">recordException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>recall how executors like <code class=\"language-text\">ForkJoinPool</code> etc. are automatically handled by automatic instrumentation for context propagation, so the asynchronous tasks are like child spans of the current task. this can be sometimes desirable and sometimes not. e.g. assume we use <code class=\"language-text\">CompletableFuture.runAsync</code>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@WithSpan</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mainOp\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">mainOp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">slumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@WithSpan</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slumber\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">slumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>with this, our current thread would not wait for the asynchronous task that we spawn off. so, we might end up with something like this -\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">--------- the trace -----------\n--- span a ---\n           --- span b ---</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\nthe parent span gets over before the child span. the issue is for e.g., our trace now becomes long-running because of span b. also, a failure in the procedure related to span b would mean our original operation would fail. these things effect sampling (long-running / erroneous traces are sampled). so, modify the slumber function above as follows -\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token keyword\">void</span> <span class=\"token function\">slumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Span</span> span <span class=\"token operator\">=</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">spanBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"slumber\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">setNoParent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">addLink</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Span</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSpanContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">startSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Scope</span> ignored <span class=\"token operator\">=</span> span<span class=\"token punctuation\">.</span><span class=\"token function\">makeCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    span<span class=\"token punctuation\">.</span><span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StatusCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ERROR</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"slumber interrupted\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    span<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\nnothing new - we use links and ensure we call <code class=\"language-text\">setNoParent</code></li>\n<li>we can configure a <code class=\"language-text\">TracerProvider</code> with parameters like -\n<ul>\n<li>span processors - called when spans are started or ended</li>\n<li>id generator - default is 16-bit ids for traces and 8-bit ids for spans</li>\n<li>span limits - put limits on span attributes, span attribute lengths, etc. to avoid faulty spans from exhausting memory, or skewing results</li>\n<li>sampler - default is to base the decision according to parent span</li>\n<li>resource</li>\n</ul>\n</li>\n<li>so, e.g. of configuring a <code class=\"language-text\">TraceProvider</code> -\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">SdkTracerProvider</span> tracerProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">SdkTracerProvider</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setIdGenerator</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IdGenerator</span><span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setSampler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Sampler</span><span class=\"token punctuation\">.</span><span class=\"token function\">parentBased</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Sampler</span><span class=\"token punctuation\">.</span><span class=\"token function\">alwaysOn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setSpanLimits</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpanLimits</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setResource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Resource</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\nuse this inside <code class=\"language-text\">setTraceProvider</code> (look inside <a href=\"#context-propagation\">context propagation</a> above)</li>\n<li>we can use cleanup methods on <code class=\"language-text\">TraceProvider</code> like <code class=\"language-text\">shutdown</code> (to make all newly created spans no op) and <code class=\"language-text\">forceFlush</code> (to export all spans that are in memory immediately) and so on</li>\n<li>span processors are invoked when a span starts or ends, so the idea is if we want to add a span processor, we configure the tracing sdk with processors that implement the <code class=\"language-text\">SpanProcessor</code> interface, which has methods <code class=\"language-text\">onStart</code>, <code class=\"language-text\">onEnd</code>, <code class=\"language-text\">shutdown</code> and <code class=\"language-text\">forceFlush</code></li>\n<li>the opentelemetry sdk provides us two processors - <code class=\"language-text\">SimpleSpanProcessor</code> to pass spans to exporters as soon as they finish, and <code class=\"language-text\">BatchSpanProcessor</code> to group spans in batches before calling the exporter\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">SdkTracerProvider</span> tracerProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">SdkTracerProvider</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">addSpanProcessor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">BatchSpanProcessor</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OtlpGrpcSpanExporter</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>the java agent uses <code class=\"language-text\">BatchSpanProcessor</code> with some defaults which me might have to configure for production systems. <code class=\"language-text\">BatchSpanProcessor</code> also exports metrics like queue size, number of items in queue, etc</li>\n<li>the exporter used in the code snippet above was otlp + grpc, but we can use jaeger, zipkin, etc. for configuring the java agent, we use <code class=\"language-text\">otel.traces.exporter</code></li>\n<li>the trace context contains the following fields -\n<ul>\n<li>trace id - 16-bit id by default</li>\n<li>span id - 8-bit id by default</li>\n<li>trace flags - the only flag currently available is “sampled”, which indicates whether the trace is sampled</li>\n<li>trace state - vendor specific information, e.g. probability based sampling</li>\n</ul>\n</li>\n<li>the two solutions for context propagation by opentelemetry is\n<ul>\n<li>to support multiple propagators using a composite propagator</li>\n<li>to standardize header formats with the help of w3c for w3c Baggage and w3c TraceContext</li>\n</ul>\n</li>\n<li>so, the w3c TraceContext format outlines the following http headers -\n<ul>\n<li><code class=\"language-text\">traceparent</code> - it has the format <code class=\"language-text\">version-traceId-parentId-traceFlag</code>. the idea is that the client injects its last active span id into the request headers, which the server then extracts to make it as its own current active span, so that all new spans that are created are children of this span. trace flag will only have one bit around sampling while version represents the version of w3c TraceContext specification</li>\n<li><code class=\"language-text\">tracestate</code> - for vendor specific information. uses the same format as w3c Baggage described above</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"metrics\" style=\"position:relative;\"><a href=\"#metrics\" aria-label=\"metrics permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Metrics</h1>\n<ul>\n<li>measurements using different aggregations</li>\n<li>they are more for kpi (key performance indicators) than incident resolution</li>\n<li>we decorate metric data by exemplars i.e. with other signals like tracing data. this is possible due to the same context propagation ecosystem it uses as other signals</li>\n<li>sometimes, aggregations can be done by the observability backend but sometimes, we might have to do it inside the application itself for performance reasons, e.g. reporting request duration for all requests by all running instances individually can be troublesome</li>\n<li>measurements and aggregations are separate in opentelemetry</li>\n<li>metric cardinality - number of unique combinations of metric attributes, which directly correlates to the number of data points exported from a service. so, if we add granular data to attributes like session id, it can lead to too many data points and therefore “cardinality explosion”</li>\n<li>just like we obtain a <code class=\"language-text\">Tracer</code> from a <code class=\"language-text\">TracerProvider</code>, we obtain a <code class=\"language-text\">Meter</code> from a <code class=\"language-text\">MeterProvider</code> using name, version, schema url and attributes as well\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">Meter</span> meter <span class=\"token operator\">=</span> openTelemetry<span class=\"token punctuation\">.</span><span class=\"token function\">meterBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"my-meter\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setInstrumentationVersion</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0.1.0\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>again, just like in case of a <code class=\"language-text\">Tracer</code>, asking for a <code class=\"language-text\">Meter</code> using the same parameters of name, version and schema url results in the same <code class=\"language-text\">Meter</code> instance</li>\n<li>we create <code class=\"language-text\">Instrument</code>s from a <code class=\"language-text\">Meter</code> using name, kind, unit and description</li>\n<li>duplicate instrument registration - if we try creating multiple instruments from the same meter using the same parameters, we get a warning for duplicate instrument registration. in java, this would result in duplicate metrics. in some implementation, some deduplication logic might be there, e.g. retaining the longer description of the two instruments / converting the units of one instrument to another and so on. note that duplicate instrument registration is a thing only when doing it using the same meter, not different meters, since each meter can be thought of like its own namespace</li>\n<li>my understanding - in tracer, we create spans from a tracer and that is the end. however here, we create instruments from meters but then instruments create measurements</li>\n<li>synchronous vs asynchronous - synchronous measurements are reported as a part of application logic, e.g. number of orders processed, while asynchronous measurements are created on demand, e.g. cpu temperature at a given time. for asynchronous measurements, instruments are created with a callback which is invoked when we need to report measurements. due to its nature, unlike asynchronous measurements, synchronous measurements have access to context</li>\n<li>monotonic - f(x) can only increase or decrease with increase in x. note - reported metrics can increase or decrease with x if the metric is a delta, and not the actual value. e.g. an increment of 5 in number of orders processed and then an increment of 2</li>\n<li>recall how we obtain instruments from meters using name, kind, unit and description</li>\n<li>we can add attributes to the measurements we emit (remember to consider metric cardinality)</li>\n<li>note - i don’t understand this right now completely - apparently, we should avoid sending duplicate measurements in an asynchronous instruments (i.e. measurements having same attributes)</li>\n<li>instrument kinds can be as follows. note - the instruments have chained helpers like <code class=\"language-text\">ofLongs</code>, <code class=\"language-text\">ofDoubles</code>, etc. to change the data type of the measurement we record\n<ul>\n<li>counter - monotonically increasing\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">LongCounter</span> counter <span class=\"token operator\">=</span> meter\n  <span class=\"token punctuation\">.</span><span class=\"token function\">counterBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tickets.sold\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">setDescription</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"number of tickets sold\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ncounter<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Attributes</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token function\">stringKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"myKey\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"myValue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>asynchronous counter - also called observable counter. note - unlike in the counter above where we send the delta values, we are expected to send the absolute value here and not the delta\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">ObservableLongCounter</span> counter <span class=\"token operator\">=</span> meter<span class=\"token punctuation\">.</span><span class=\"token function\">counterBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mycounter\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">buildWithCallback</span><span class=\"token punctuation\">(</span>measurement <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    measurement<span class=\"token punctuation\">.</span><span class=\"token function\">record</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Attributes</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AttributeKey</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"myKey\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>histogram - for measurements that exhibit meaningful statistical distributions, e.g. 95th percentile of request duration (i.e. the value below which 95% of all values are found)</li>\n<li>updown counter - for non-monotonic measurements unlike up down counter. again, we just record the delta like in counters, while the total value is reported automatically for us?</li>\n<li>asynchronous updown counter - prefer over normal updown counter when maintaining the final value is trivial since this is computationally less expensive. e.g. if computing queue size is difficult but recording number of items which were added or deleted is easy, use normal updown counter</li>\n<li>asynchronous gauge - again also called observable gauge. note - if values are additive (e.g. we can sum the heap usage across processes) use asynchronous counters / asynchronous updown counters</li>\n</ul>\n</li>\n<li>using a <code class=\"language-text\">MeterProvider</code>, we can configure “meter readers” which can collect measurements and export them to backends, “views” which can dynamically perform aggregations and process attributes, and “resource” (already discussed in earlier sections)</li>\n<li>the aggregation functions in opentelemetry are decomposable. decomposable aggregation functions can be computed by distributed systems parallely for individual subsets and combined into one final value at the end, e.g. sum. sometimes to decompose aggregation functions like average, auxiliary values like total and count mught be needed for each subset</li>\n<li>the default aggregation kind for all the 4 kinds of instrumentation counter is sum, for gauge is last value and for histogram is explicit bucket histogram</li>\n<li>sum and last value aggregation types are self-explanatory</li>\n<li>explicit bucket histogram - we put values into buckets. whenever a measurement is produced, its corresponding bucket is calculated and then the counter of that bucket is increased. sometimes, some approximate calculation might be needed. e.g. we want to know the 90th percentile of 200 produced measurements. if the sum of counts of a set of buckets ends / starts at 180, we can predict this, but what if ends at a count of 170 upto bucket n and 190 for bucket n + 1? so, interpolation is used here. more buckets means more cost of storage etc. but also more precision</li>\n<li>views - can be used to change the attributes, naming, etc. of the measurements which are produced. we provide an instrument selection criteria and based on that, we can override the name, description, attributes and aggregation type of the instrument. for the selection criteria, we can use wildcards in instrument name\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-java line-numbers\"><code class=\"language-java\"><span class=\"token class-name\">SdkMeterProvider</span> sdkMeterProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">SdkMeterProvider</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">registerView</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">InstrumentSelector</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">setType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InstrumentType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">COUNTER</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">setName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*-counter\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">setMeterName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"my-meter\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">setMeterVersion</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1.0.0\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">setMeterSchemaUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://example.com\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">View</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">setAggregation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Aggregation</span><span class=\"token punctuation\">.</span><span class=\"token function\">explicitBucketHistogram</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>with exemplars, we can get access to more granular data. this granular data includes -\n<ul>\n<li>individual measurements. recall how measurements are aggregated depending on the instrument / aggregation kind which we configured. with this, we can get access to the individual parameters of measurements values, attributes, timestamp, etc</li>\n<li>trace information to help correlate different signals of opentelemetry</li>\n</ul>\n</li>\n<li>todo - metric readers and exporters, aggregation temporality</li>\n</ul>\n<h1 id=\"logging\" style=\"position:relative;\"><a href=\"#logging\" aria-label=\"logging permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Logging</h1>\n<ul>\n<li>twelve factor app methodology says that log routing and storage should not be a part of applications. they should only write unbuffered logs to stdout, which should then be sent to observability backends</li>\n<li>we do not usually sample logs like traces. so, this means logs will have a lot of data that is unimportant. this also means storing logs will be more expensive, there will be more delays in exporting logs etc</li>\n<li>we can also have metrics on logs, e.g. a metric on the number of logs with level as error</li>\n<li>the idea of opentelemetry is to add contextual data like trace and span ids to existing logs which use logging frameworks like log4j2 and logback. this can be done via handlers and appenders, etc</li>\n<li>structured logs - logs can also have standard and custom attributes. so, there are two different concepts in opentelemetry - log records (what we are generally used to) and events</li>\n<li>so, opentelemetry provides a logging interface (not to be used, since we should use existing logging frameworks) and an events interface for log records and events respectively</li>\n<li>the logging interface is used by the handlers and appenders bts</li>\n<li>the idea is <code class=\"language-text\">LoggerProvider</code> can be used to obtain instances of <code class=\"language-text\">Logger</code> or <code class=\"language-text\">EventLogger</code></li>\n<li>the parameters to obtain them from the provider contain the usual name, version, schema url, attributes and additionally a boolean which determines whether log records should contain trace information</li>\n<li>again, the same logger instance is returned when we use the same name, version and schema url</li>\n<li>the <code class=\"language-text\">Logger</code> emits instances of <code class=\"language-text\">LogRecord</code></li>\n<li>properties of the log record -\n<ul>\n<li>timestamp - unix epoch, when the event occurred</li>\n<li>observed timestamp - unix epoch, when the event was collected by opentelemetry collector</li>\n<li>context - can help obtain <code class=\"language-text\">TraceContext</code></li>\n<li>severity number - severity of log, e.g. 17-20 represent error events</li>\n<li>severity text - humanreadable description of the severity i.e. log level</li>\n<li>body - log message</li>\n<li>attributes</li>\n</ul>\n</li>\n<li>we can also use the <code class=\"language-text\">EventLogger</code> interface for emitting events. personally, i am unable to see its use just yet</li>\n<li>again, to configure a <code class=\"language-text\">LoggerProvider</code>, we can use resources and log record processors</li>\n<li>again, remember all three providers have <code class=\"language-text\">shutdown</code> and <code class=\"language-text\">forceFlush</code> functionality</li>\n<li>again, we can configure limits around number or lengths of attributes via the java agent</li>\n<li>again, we have <code class=\"language-text\">LogRecordProcessor</code> and <code class=\"language-text\">LogRecordExporter</code></li>\n<li>again, opentelemetry ships with two processors - <code class=\"language-text\">SimpleLogRecordProcessor</code> and <code class=\"language-text\">BatchLogRecordProcessor</code></li>\n<li>context information e.g. span context information can be injected into logs using for e.g. mdc in java</li>\n<li>log appenders and handlers can be used to send logs from standard logging frameworks to the configured <code class=\"language-text\">LoggerProvider</code> by emitting <code class=\"language-text\">LogRecords</code> via the <code class=\"language-text\">Logger</code> interface</li>\n</ul>\n<h1 id=\"otlp\" style=\"position:relative;\"><a href=\"#otlp\" aria-label=\"otlp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OTLP</h1>\n<ul>\n<li>opentelemetry protocol</li>\n<li>works for all signal types - traces, metrics and logs</li>\n<li>designed for high throughput</li>\n<li>can batch telemetry data, use compression (gzip) and utilize encryption by using https / tls</li>\n<li>retries, backpressure, throttling, acknowledgements, exponential backoff, etc. is also a part of it</li>\n<li>otlp over grpc is preferred, but we can also use otlp over http</li>\n<li>the payload is encoded in the form of protobuf (protocol buffers) by default, but json is supported as well</li>\n</ul>\n<h1 id=\"collector\" style=\"position:relative;\"><a href=\"#collector\" aria-label=\"collector permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Collector</h1>\n<ul>\n<li>collect data in various formats like otlp, prometheus, zipkin</li>\n<li>process in multiple ways e.g. to aggregate, sample and transform it</li>\n<li>export it to multiple backends</li>\n<li>the idea is that the java agent auto instruments our code and sends it to the collector in otlp. then, the collector can forward it to multiple observability backends using the protocol that the backend prefers</li>\n<li>so, we have two repositories - <a href=\"https://github.com/open-telemetry/opentelemetry-collector\">opentelemetry collector</a> and the <a href=\"https://github.com/open-telemetry/opentelemetry-collector-contrib\">opentelemetry collector contrib</a> which includes the prior and processors, receivers and exporters for opensource observability backends</li>\n<li>the collector is distributed as a go binary (or docker image containing the same thing). there are two modes to run the collector - either as an “agent” (sidecar / daemon process) or as a “gateway” (standalone, horizontally scalable for a centralized point of authentication etc.)</li>\n<li>todo - there is some stuff around kubernetes with helm charts etc</li>\n<li>example with container sidecar -\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> otel/opentelemetry<span class=\"token punctuation\">-</span>collector\n<span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"--config=/etc/otel-config.yaml\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> ./otel<span class=\"token punctuation\">-</span>config.yaml<span class=\"token punctuation\">:</span>/etc/otel<span class=\"token punctuation\">-</span>config.yaml\n<span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"4317:4317\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>receivers ingest data. receivers can be pull based (e.g. prometheus) or push based (e.g. zipkin, otlp). e.g. when using pull based receivers, we might have to provide extra configuration in the yaml config file around the target to pull this data from</li>\n</ul>","frontmatter":{"title":"Opentelemetry"}}},"pageContext":{"id":"a30e3675-92ac-5c9c-9fa4-e0693aa2559a"}},"staticQueryHashes":["1037383464","1617985380"]}